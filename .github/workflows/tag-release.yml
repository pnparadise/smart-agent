name: Build Release APK on Tag

on:
  push:
    tags:
      - '*'

jobs:
  build-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…é¡»ä¿ç•™ï¼Œç”¨äºŽå‘å¸ƒ Release

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. Java çŽ¯å¢ƒä¿æŒä¸å˜
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      # Flutter çŽ¯å¢ƒå¼€å¯ç¼“å­˜
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true # ðŸ”¥ å¼€å¯ SDK ç¼“å­˜ï¼Œç¬¬äºŒæ¬¡æž„å»ºæ—¶æ— éœ€é‡æ–°ä¸‹è½½ Flutter

      # ä¸“é—¨çš„ Gradle è®¾ç½®ä¸Žç¼“å­˜
      # è¿™ä¸ª Action ä¼šè‡ªåŠ¨ç¼“å­˜ ~/.gradle/caches å’Œ ~/.gradle/wrapper
      # å¹¶ä¸”ä¼šå¤ç”¨ä¸Šä¸€æ¬¡æž„å»ºçš„ç¼–è¯‘äº§ç‰©ï¼Œå¤§å¹…å‡å°‘æž„å»ºæ—¶é—´
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false # å…è®¸å†™å…¥ç¼“å­˜

      - name: Install dependencies
        run: flutter pub get

      - name: Prepare version info
        id: version
        run: |
          TAG_NAME="${GITHUB_REF_NAME}"
          # é’ˆå¯¹ latest æ ‡ç­¾çš„ç‰¹æ®Šå¤„ç†é€»è¾‘ä¿æŒä¸å˜
          if [ "$TAG_NAME" == "latest" ]; then
             # ä½¿ç”¨ run_number ä¿è¯è‡ªå¢ž
             BUILD_NUMBER=${{ github.run_number }}
          else
             # æ™®é€š Tag æå–æ•°å­—
             BUILD_NUMBER=$(echo "${TAG_NAME}" | tr -cd '0-9')
             if [ -z "$BUILD_NUMBER" ]; then BUILD_NUMBER=1; fi
          fi
          echo "TAG_NAME=$TAG_NAME" >> "$GITHUB_ENV"
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> "$GITHUB_ENV"

      # 4. æž„å»º APK
      - name: Build release APK
        run: flutter build apk --release --build-name "$TAG_NAME" --build-number "$BUILD_NUMBER"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-${{ env.TAG_NAME }}
          path: build/app/outputs/flutter-apk/app-release.apk
          if-no-files-found: error

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: build/app/outputs/flutter-apk/app-release.apk
          name: ${{ env.TAG_NAME }}
          tag_name: ${{ env.TAG_NAME }}
          prerelease: ${{ env.TAG_NAME == 'latest' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}